- name: Generate VS with WAF policy
  delegate_to: localhost
  block:
    - name: Get policy setting for VS
      set_fact:
        policy: "{{ app_sec_policies | selectattr('name', 'equalto', app_sec_policy) | list | first }}"

    - name: Generate policy
      block:
        - name: Render policy to JSON
          set_fact:
            policy_json: "{{ lookup('template', '{{ root_dir }}/templates/app-sec-policy.json.j2') | to_json(indent=2) }}"

        - name: Store policy as artifact
          copy:
            content: "{{ policy_json }}"
            dest: "{{ conf_dir }}/app-sec-policy.json"

    - name: Generate VS config
      copy:
        content: "{{ lookup('template', '{{ root_dir }}/templates/app.json.j2') | to_json(indent=2) }}"
        dest: "{{ conf_dir }}/virtual-server.json"
      vars:
        id: "{{ last_run_time }}"
        vs: "{{ virtual_servers[0] }}"
